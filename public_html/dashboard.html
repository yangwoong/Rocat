<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dashboard (50m Grid + GPS + Heading + Video)</title>
  <style>
    html, body { margin:0; height:100%; }
    body { display:flex; font-family: system-ui, Arial, sans-serif; }
    #map { flex:2; }
    /* 오른쪽 패널: 3:3:4 비율 */
    #side {
      flex:1; display:grid; grid-template-rows: 3fr 3fr 4fr;
      border-left:1px solid #ddd; height:100%;
      min-width: 380px;
    }
    /* 각 섹션 공통 */
    .panel { padding:12px; min-height:0; display:flex; flex-direction:column; }
    .panel h2 { margin:0 0 8px 0; font-size:16px; }
    .scroll {
      flex:1; overflow:auto; border:1px solid #eee; border-radius:8px;
      background:#fafafa; padding:8px;
    }
    .card { border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:8px; background:#fff; cursor:pointer; }
    .card button { cursor:pointer; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eee; margin-right:6px; font-size:12px; }

    /* 채팅 UI */
    #chat { border-top:1px solid #eee; }
    #chat-log { display:flex; flex-direction:column; gap:8px; }
    #chatList { display:flex; flex-direction:column; gap:8px; }
    #chat-box { display:flex; gap:8px; margin-top:8px; }
    #chat-input { flex:1; padding:8px; }
    #send-btn { padding:8px 12px; }

    .bubble-user {
      align-self: flex-end; background:#1976D2; color:white;
      padding:8px 12px; border-radius:16px 16px 0 16px;
      max-width:70%; word-break:break-word;
    }
    .bubble-bot {
      align-self: flex-start; background:#E0E0E0; color:black;
      padding:8px 12px; border-radius:16px 16px 16px 0;
      max-width:70%; word-break:break-word;
    }
    .bubble-mission {
      align-self: center; background:#FFF3E0; color:#5D4037;
      padding:10px 12px; border-radius:12px; border:1px solid #FFE0B2;
      max-width:80%; word-break:break-word;
    }
    .mission-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .mission-row button { padding:6px 10px; }

    /* 비디오 모달 */
    .modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:12px; border-radius:8px; width:800px; max-width:95%; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .modal-body { max-height:70vh; overflow:auto; }

    /* typing indicator */
    .bubble.typing {
      align-self:flex-start;
      background:#ffffff;
      color:#111;
      border-bottom-left-radius:4px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .typing-text { font-size:13px; }
    .typing-dots {
      display:inline-flex;
      gap:2px;
    }
    .typing-dots i {
      width:6px;
      height:6px;
      border-radius:50%;
      background:#9ca3af; /* 연회색 점 */
      display:inline-block;
      animation: blink 1.4s infinite both;
    }
    .typing-dots i:nth-child(2) { animation-delay: .2s; }
    .typing-dots i:nth-child(3) { animation-delay: .4s; }

    @keyframes blink {
      0% { opacity: 0.2; }
      20% { opacity: 1; }
      100% { opacity: 0.2; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="side">
    <!-- 1) 최근 수질 (3) -->
    <div id="wq" class="panel">
      <h2>최근 수질</h2>
      <div id="wq-list" class="scroll"></div>
    </div>

    <!-- 2) 드론 상태 (3) -->
    <div id="drones" class="panel">
      <h2>드론 상태</h2>
      <div id="drone-list" class="scroll"></div>
    </div>

    <!-- 3) 임무 채팅 (4) -->
    <div id="chat" class="panel">
      <h2>임무 채팅</h2>
      <div id="chat-log" class="scroll">
        <div id="chatList" class="scroll">
          <div class="bubble ai">임무생성을 위한 구역을 선택하세요.</div>
        </div>
      </div>
      <div id="chat-box">
        <input id="chat-input" type="text" placeholder="메시지를 입력하세요..."/>
        <button id="send-btn" type="button">전송</button>
      </div>
    </div>
  </div>

  <!-- 영상 모달 -->
  <div id="videoModal" class="modal" onclick="hideVideo()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div id="videoTitle"><b>드론 영상</b></div>
        <button onclick="hideVideo()">닫기</button>
      </div>
      <div class="modal-body">
        <img id="videoStream" src="" style="width:100%; height:auto;"/>
      </div>
    </div>
  </div>

  <script>
    let map, gridRecs = [], droneMarkers = new Map(), sending = false;

    function ragColor(chla){
      // BLUE(관심), YELLOW(주의), ORANGE(경계), RED(심각)
      if(chla < 10) return '#64B5F6';     // BLUE
      if(chla < 20) return '#FFF176';     // YELLOW
      if(chla < 30) return '#FFB74D';     // ORANGE
      return '#E57373';                   // RED
    }

    function wamisGrade(sample){
        //const levels = [
        //    {label:"매우좋음",   color:"#2196F3"}, // 1 매우좋음  BLUE
        //    {label:"좋음",color:"#03A9F4"}, // 2 좋음   SKYBLUE
        //    {label:"약간좋음",  color:"#4CAF50"}, // 3 약간좋음   GREEN
        //    {label:"보통", color:"#FFEB3B"}, // 4 보통   YELLOW
        //    {label:"약간나쁨", color:"#FF9800"}, // 5 약간나쁨   ORANGE
        //    {label:"나쁨",    color:"#F44336"}, // 6 나쁨     RED
        //    {label:"매우나쁨", color:"#9C27B0"}  // 7 매우나쁨   PURPLE
        // ];
        // 기본값
        let used = null;
        let val = null;
        let lvl = 7; // 최악 등급
        let label = "매우나쁨";
        let color = "#9C27B0";

        used = sample.reason;
        if(sample.curr_wq_state == "Ia") { lvl=1; label="매우좋음";    color="#2196F3"; }
        else if(sample.curr_wq_state == "Ib"){ lvl=2; label="좋음"; color="#03A9F4"; }
        else if(sample.curr_wq_state == "II"){ lvl=3; label="약간좋음";   color="#4CAF50"; }
        else if(sample.curr_wq_state == "III"){ lvl=4; label="보통";  color="#FFEB3B"; }
        else if(sample.curr_wq_state == "IV"){ lvl=5; label="약간나쁨";  color="#FF9800"; }
        else if(sample.curr_wq_state == "V"){ lvl=6; label="나쁨";      color="#F44336"; }
        else { lvl=7; label="매우나쁨";   color="#9C27B0"; }
        return {lvl,label,color,used,val};
      
        // 1) 용존산소량 (do_mg_l)
        if(sample.do_mg_l !== undefined && sample.do_mg_l !== null){
          used = "DO";
          val = sample.do_mg_l;
          if(val >= 7.5) { lvl=1; label="매우좋음";    color="#2196F3"; }
          else if(val >= 5.0){ lvl=2; label="좋음"; color="#03A9F4"; }
          else if(val >= 3.0){ lvl=3; label="약간좋음";   color="#4CAF50"; }
          else if(val >= 2.0){ lvl=4; label="보통";  color="#FFEB3B"; }
          else if(val >= 1.0){ lvl=5; label="약간나쁨";  color="#FF9800"; }
          else if(val > 0.5){ lvl=6; label="나쁨";      color="#F44336"; }
          else              { lvl=7; label="매우나쁨";   color="#9C27B0"; }
          return {lvl,label,color,used,val};
        }
      
        // 2) 화학적 산소요구량 (cod_mg_l)
        if(sample.cod_mg_l !== undefined && sample.cod_mg_l !== null){
          used = "COD";
          val = sample.cod_mg_l;
          if(val <= 3) { lvl=1; label="매우좋음"; color="#2196F3"; }
          else if(val <= 5){ lvl=2; label="좋음"; color="#03A9F4"; }
          else if(val <= 8){ lvl=3; label="약간좋음"; color="#4CAF50"; }
          else if(val <= 11){ lvl=4; label="보통"; color="#FFEB3B"; }
          else if(val <= 15){ lvl=5; label="약간나쁨"; color="#FF9800"; }
          else if(val <= 20){ lvl=6; label="나쁨"; color="#F44336"; }
          else { lvl=7; label="매우나쁨"; color="#9C27B0"; }
          return {lvl,label,color,used,val};
        }
      
        // 3) 수소이온농도 (ph)
        if(sample.ph !== undefined && sample.ph !== null){
          used = "pH";
          val = sample.ph;
          if(val >= 6.5 && val <= 8.5){ lvl=1; label="매우좋음"; color="#2196F3"; }
          else if(val >= 6.0 && val <= 9.0){ lvl=3; label="약간좋음"; color="#4CAF50"; }
          else { lvl=6; label="나쁨"; color="#F44336"; }
          return {lvl,label,color,used,val};
        }
      
        // 4) 생물학적 산소요구량 (bod_mg_l)
        if(sample.bod_mg_l !== undefined && sample.bod_mg_l !== null){
          used = "BOD";
          val = sample.bod_mg_l;
          if(val <= 1){ lvl=1; label="매우좋음"; color="#2196F3"; }
          else if(val <= 3){ lvl=2; label="좋음"; color="#03A9F4"; }
          else if(val <= 5){ lvl=3; label="약간좋음"; color="#4CAF50"; }
          else if(val <= 8){ lvl=4; label="보통"; color="#FFEB3B"; }
          else if(val <= 10){ lvl=5; label="약간나쁨"; color="#FF9800"; }
          else if(val <= 15){ lvl=6; label="나쁨"; color="#F44336"; }
          else { lvl=7; label="매우나쁨"; color="#9C27B0"; }
          return {lvl,label,color,used,val};
        }
      
        // 5) 탁도 (ss_mg_l)
        if(sample.ss_mg_l !== undefined && sample.ss_mg_l !== null){
          used = "SS";
          val = sample.ss_mg_l;
          if(val <= 25){ lvl=1; label="매우좋음"; color="#2196F3"; }
          else if(val <= 50){ lvl=2; label="좋음"; color="#03A9F4"; }
          else if(val <= 100){ lvl=3; label="약간좋음"; color="#4CAF50"; }
          else if(val <= 200){ lvl=4; label="보통"; color="#FFEB3B"; }
          else if(val <= 500){ lvl=5; label="약간나쁨"; color="#FF9800"; }
          else if(val <= 1000){ lvl=6; label="나쁨"; color="#F44336"; }
          else { lvl=7; label="매우나쁨"; color="#9C27B0"; }
          return {lvl,label,color,used,val};
        }
      
      return {lvl,label,color,used:"N/A",val:null};
    }
       

    function arrowIcon(headingDeg){
      // heading: 0=북, 시계방향 / Symbol 0deg=동 → 회전 보정 -90
      const rotation = (headingDeg ?? 0) - 90;
      return {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 4,
        rotation: rotation,
        fillColor: '#1976D2', fillOpacity: 1,
        strokeColor: '#ffffff', strokeWeight: 1
      };
    }

    // ...기존 코드 상단 유틸 근처에 추가
    async function getTileCentroid(zone_id){
        try{
          // 웹서버 프록시 처리함 http://211.43.213.175:8580
          const gturl = '/api/tiles/centroid?zone_id='+encodeURIComponent(zone_id);
          // console.log("tile:"+gturl);
          const res = await fetch(gturl);
          if(!res.ok) throw new Error("centroid api error");
          const js = await res.json();
          return {lat: js.lat, lon: js.lon};
        }catch(e){
        // 백엔드 API가 아직 없거나 에러면, 지도상의 polygon에서 대략 중심 추정 (fallback)
        const rec = gridRecs.find(r => r.zone_id === zone_id);
        if(rec){
            const path = rec.poly.getPath().getArray();
            const cx = path.reduce((s,p)=>s+p.lat(),0)/path.length;
            const cy = path.reduce((s,p)=>s+p.lng(),0)/path.length;
            return {lat: cx, lon: cy};
        }
        return {lat: null, lon: null};
        }
    }
    function fmtCoord(v, d=6){ return (v===null||v===undefined||isNaN(v)) ? "-" : Number(v).toFixed(d); }

    async function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.3804191, lng: 127.0028335}, zoom: 17
      });
      await drawGrid();
      refreshWQ();   setInterval(refreshWQ,   10000);
      refreshDrones(); setInterval(refreshDrones, 10000);
    }

    function clearGrid(){
      gridRecs.forEach(r => { r.poly.setMap(null); r.overlay.setMap(null); });
      gridRecs = [];
    }

    async function drawGrid(){
      clearGrid();
      // 웹서버 프록시 처리함 http://211.43.213.175:8580
      const res = await fetch('/api/tiles');
      const js = await res.json();
      if(!js.ok){ alert('타일 조회 에러'); return; }

      for(const f of js.features){
        const path = f.geometry.coordinates[0].map(([lng,lat])=>({lat, lng}));
        const poly = new google.maps.Polygon({
          paths: [path],
          strokeColor: '#546E7A', strokeOpacity: 0.8, strokeWeight: 1,
          fillColor: '#ECEFF1', fillOpacity: 0.15
        });
        poly.setMap(map);

        // 좌상단 라벨 (lat 최대 & lng 최소)
        let corner = path.reduce((best, p) => {
          if (!best) return p;
          if (p.lat > best.lat || (p.lat === best.lat && p.lng < best.lng)) return p;
          return best;
        }, null);

        const labelDiv = document.createElement("div");
        labelDiv.style.position = "absolute";
        labelDiv.style.color = "black";
        labelDiv.style.fontSize = "10px";
        labelDiv.style.background = "rgba(255,255,255,0.7)";
        labelDiv.style.padding = "1px 2px";
        labelDiv.style.borderRadius = "4px";
        labelDiv.innerText = f.properties.zone_id;

        const overlay = new google.maps.OverlayView();
        overlay.onAdd = function(){
          this.getPanes().overlayLayer.appendChild(labelDiv);
        };
        overlay.draw = function(){
          const proj = this.getProjection();
          const pos = proj.fromLatLngToDivPixel(new google.maps.LatLng(corner.lat, corner.lng));
          labelDiv.style.left = pos.x + "px";
          labelDiv.style.top  = pos.y + "px";
        };
        overlay.onRemove = function(){ if(labelDiv.parentNode) labelDiv.parentNode.removeChild(labelDiv); };
        overlay.setMap(map);

        gridRecs.push({zone_id: f.properties.zone_id, poly, overlay, chla: null});
      }
    }

    function safe(val, digits=1){
        return (val !== undefined && val !== null && !isNaN(val)) 
            ? Number(val).toFixed(digits) 
            : "-";
    }

    // ---------- 최근 수질 ----------
    async function refreshWQ(){
      // 웹서버 프록시 처리함 http://211.43.213.175:8580
      const res = await fetch('/api/samples/latest'); 
      const js = await res.json();
      const list = document.getElementById('wq-list');
      list.innerHTML = '';
      const latestMap = new Map();
      for(const s of js.items){ latestMap.set(s.zone_id, s); }

      for(const r of gridRecs){
        const s = js.items.find(x => x.zone_id === r.zone_id);
        if(s){
          
          const grade = wamisGrade(s);
          r.poly.setOptions({fillColor: grade.color, fillOpacity: 0.5});
          const row = document.createElement('div');
          row.className='card';
          row.innerHTML = `
                <div>
                <span class="badge" style="background:${grade.color};color:#000;font-size:16px;">${grade.label}</span>
                <b>${r.zone_id}</b>-목표수질: 보통(${s.curr_wq_state})
                <font style="font-size:10px;">AI판단: ${grade.used} </font>
                </div>
                <div style="font-size:12px; margin-top:4px;">
                DO ${s.do_mg_l ?? "-"}, COD ${s.cod_mg_l ?? "-"}, pH ${s.ph ?? "-"}, 
                BOD ${s.bod_mg_l ?? "-"}, SS ${s.ss_mg_l ?? "-"}
                </div>
            `;
          // 목표값 반환  

          row.addEventListener('click', () => createMissionBubble(r.zone_id, s, grade));
          list.appendChild(row);
        }
      }
      
    }

    // ---------- 드론 ----------
    async function refreshDrones(){
      // 웹서버 프록시 처리함 http://211.43.213.175:8580
      const res = await fetch('/api/drones'); 
      const js = await res.json();
      const cont = document.getElementById('drone-list');
      cont.innerHTML = '';

      const seen = new Set();
      for(const [id, d] of Object.entries(js.drones)){
        seen.add(id);
        const div = document.createElement('div');
        div.className = 'card';
        const lat = d.lat?.toFixed ? d.lat.toFixed(6) : d.lat;
        const lon = d.lon?.toFixed ? d.lon.toFixed(6) : d.lon;
        const hdg = (d.heading ?? '-');
        div.innerHTML = `<b>${id}</b><br/>
          상태: ${d.status || 'IDLE'} / 배터리: ${d.battery ?? '-'}%<br/>
          위치: ${lat ?? '-'}, ${lon ?? '-'} / 타일: ${d.zone_id ?? '-'} / 방위: ${hdg}°<br/>
          <button ${d.video_url ? '' : 'disabled'} onclick="openVideo('${id}', '${d.video_url || ''}')">영상 보기</button>`;
        cont.appendChild(div);

        if(d.lat && d.lon){
          let m = droneMarkers.get(id);
          if(!m){
            m = new google.maps.Marker({
              position: {lat: d.lat, lng: d.lon},
              map, title: id, icon: arrowIcon(d.heading)
            });
            droneMarkers.set(id, m);
          }else{
            m.setPosition({lat: d.lat, lng: d.lon});
            m.setIcon(arrowIcon(d.heading));
          }
        }
      }
      // stale marker 제거
      for(const [id, m] of droneMarkers.entries()){
        if(!seen.has(id)){ m.setMap(null); droneMarkers.delete(id); }
      }
    }

    // ---------- 임무 채팅 ----------
    const chatListEl = document.getElementById('chatList');
    const chatLogEl  = document.getElementById('chat-log');
    let typingEl = null;

    function appendBubble(text, cls){
      // const log = document.getElementById('chat-log');
      const div = document.createElement('div');
      div.className = cls; 
      div.innerHTML = text;
      // log.appendChild(div);
      // log.scrollTop = log.scrollHeight;
      chatListEl.appendChild(div);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
      return div;
    }

    function showTyping() {
      // 이미 표시 중이면 중복 생성 방지
      if (typingEl) return;
      typingEl = document.createElement('div');
      typingEl.className = 'bubble ai typing';
      typingEl.innerHTML = `
        <span>AI Roboat의 생각중…</span>
        <span class="typing-dots"><i></i><i></i><i></i></span>
      `;
      chatListEl.appendChild(typingEl);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    function hideTyping() {
      if (typingEl && typingEl.parentNode) {
        typingEl.parentNode.removeChild(typingEl);
      }
      typingEl = null;
    }

    // function createMissionBubble(zone_id, s){
    //   // 최근수질 클릭 시: 임무 생성 카드(버블) 추가
    //   const info = `타일 ${zone_id} ｜ Chl-a ${safe(s.chl_a_mg_m3)}, DO ${safe(s.do_mg_l)}, pH ${safe(s.ph)}, Turb ${safe(s.turb)}`;
    //   const html = `
    //     <div><b>임무</b> — ${info}</div>
    //     <div class="mission-row">
    //       <button type="button" onclick="startMission('${zone_id}')">생성</button>
    //     </div>
    //   `;
    //   appendBubble(html, 'bubble-mission');
    // }
    async function createMissionBubble(zone_id, s, grade){
        const center = await getTileCentroid(zone_id); // {lat, lon}
        // const info = `타일 ${zone_id} ｜ Chl-a ${safe(s.chl_a_mg_m3)}, DO ${safe(s.do_mg_l)}, pH ${safe(s.ph)}, Turb ${safe(s.turb)}`;        
        const coord = `GPS: ${fmtCoord(center.lat)}, ${fmtCoord(center.lon)}`;
        const info = `pH ${s.ph ?? "-"}, DO ${s.do_mg_l ?? "-"}, BOD ${s.bod_mg_l ?? "-"}, COD ${s.cod_mg_l ?? "-"}, T-N ${s.t_n_mg_l ?? "-"}, T-P ${s.t_p_mg_l ?? "-"}, Chl-a ${s.chl_a_mg_m3 ?? "-"}, CD ${s.cd_mg_l ?? "-"}, CL ${s.cl_mg_l ?? "-"}, SS ${s.ss_mg_l ?? "-"}, TOC ${s.toc_mg_l ?? "-"}, EC ${s.ec_us_cm ?? "-"}, Temp ${s.temp_c ?? "-"}`;
        
        const html = `
            <div><b>임무</b> — ${info}</div>
            <div style="margin-top:4px; font-size:12px; color:#555;">${coord}</div>
            <div class="mission-row">
            <button type="button" onclick="sendMission( '${zone_id}', '${fmtCoord(center.lat)}', '${fmtCoord(center.lon)}', 
            ${s.ph ?? "-"}, ${s.do_mg_l ?? "-"}, ${s.bod_mg_l ?? "-"}, ${s.cod_mg_l ?? "-"},  ${s.t_n_mg_l ?? "-"},  ${s.t_p_mg_l ?? "-"},
            ${s.chl_a_mg_m3 ?? "-"}, ${s.cd_mg_l ?? "-"}, ${s.cl_mg_l ?? "-"}, ${s.ss_mg_l ?? "-"}, ${s.toc_mg_l ?? "-"}, ${s.ec_us_cm ?? "-"}, ${s.temp_c ?? "-"} ,
            '${s.curr_wq_state}', '${s.target_wq_state}' )">생성</button>
            <button type="button" onclick="map.panTo({lat:${center.lat || 'null'}, lng:${center.lon || 'null'}})">지도이동</button>
            <button type="button" onclick="navigator.clipboard?.writeText('${zone_id} ${fmtCoord(center.lat)} ${fmtCoord(center.lon)}')">좌표복사</button>
            </div>
        `;
        appendBubble(html, 'bubble-mission');
    }

   
    // 임무 임시 저장소 (버튼 클릭 시 참조)
    const PENDING_MISSIONS = new Map();
    let pendingIdSeq = 1;
  
    // 안전 숫자 포매터
    function safeNum(v, d=6){
      const n = (v===null||v===undefined||v==='') ? NaN : Number(v);
      return isNaN(n) ? "-" : n.toFixed(d);
    }
  
    // 백엔드로 임무 전송
    async function postMissionToBackend(mission){
      try{
        // console.log("방법 1 결과:", JSON.stringify(mission, null, 2));

        const res = await fetch('/roboat/api/mission/start', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(mission)
        });
        const js = await res.json();
        appendBubble(`임무 전송 결과: ${JSON.stringify(js)}`, 'bubble-bot');
      }catch(e){
        appendBubble(`임무 전송 실패: ${e}`, 'bubble-bot');
        console.error(e);
      }
    }
  
    // 임무 JSON 정규화 (키가 다르게 와도 최대한 맞춰줌)
    function normalizeMission(raw){
      if(!raw || typeof raw !== 'object') return null;
  
      // 가능한 키 후보들
      const zone_id = raw.zone_id ?? raw.tile_id ?? raw.zone ?? raw.area ?? raw["zone-id"];
      let lat = raw.lat ?? raw.latitude;
      let lon = raw.lon ?? raw.lng ?? raw.longitude;
      const mission_idx = raw.mission_idx ?? raw.id ?? raw.missionId ?? raw.idx ?? Date.now();
      const link_mission_idx = raw.link_mission_idx ?? raw.parent_mission_idx ?? 0;
      const curr_wq_state = raw.curr_wq_state ?? raw.current_wq ?? raw.currentState ?? raw.current ?? raw.curr ?? null;
      const target_wq_state = raw.target_wq_state ?? raw.target_wq ?? raw.targetState ?? raw.target ?? null;
      const response = raw.response ?? raw.text ?? raw.description ?? JSON.stringify(raw);
  
      // 문자열 강제(요구사항에 맞춤). 없으면 후속 보완 단계에서 채움
      if(lat!==undefined && lat!==null) lat = String(lat);
      if(lon!==undefined && lon!==null) lon = String(lon);
  
      return { mission_idx, link_mission_idx, zone_id, lat, lon, curr_wq_state, target_wq_state, response };
    }
  
    // 응답(문자열/객체)에서 임무 JSON을 추출
    function tryExtractMission(any){
      // 1) 이미 객체면 바로 정규화 시도
      if(any && typeof any === 'object'){
        // 흔한 래핑: { mission: {...} } / { data: {...} } / { payload: {...} }
        const possible = any.mission ?? any.data ?? any.payload ?? any.result ?? any;
        const norm = normalizeMission(possible);
        if(norm && (norm.zone_id || (norm.lat && norm.lon))) return norm;
      }
  
      // 2) 문자열 안 JSON 블록 추출
      if(typeof any === 'string'){
        // 가장 바깥 { ... } 를 찾는 단순 정규식
        const m = any.match(/\{[\s\S]*\}/);
        if(m){
          try{
            const obj = JSON.parse(m[0]);
            const norm = normalizeMission(obj);
            if(norm && (norm.zone_id || (norm.lat && norm.lon))) return norm;
          }catch(_){}
        }
      }
  
      return null;
    }
  
    // zone_id만 있고 lat/lon이 없으면, 타일 centroid를 보완
    async function fillCentroidIfMissing(mission){
      if((!mission.lat || !mission.lon) && mission.zone_id){
        const center = await getTileCentroid(mission.zone_id).catch(()=>null);
        if(center && center.lat && center.lon){
          mission.lat = String(center.lat);
          mission.lon = String(center.lon);
        }
      }
      return mission;
    }
  
    // 임무 액션 버블 그리기
    async function renderMissionActionBubble(mission){
      // 좌표 보완
      await fillCentroidIfMissing(mission);
  
      const id = pendingIdSeq++;
      PENDING_MISSIONS.set(id, mission);
  
      const summary = `
        <div><b>임무 수신</b></div>
        <div style="font-size:12px;margin-top:4px;">
          zone: <b>${mission.zone_id ?? '-'}</b>,
          lat: ${safeNum(mission.lat)}, lon: ${safeNum(mission.lon)}
        </div>
        <div style="font-size:12px;margin-top:2px;">
          curr: ${mission.curr_wq_state ?? '-'} → target: ${mission.target_wq_state ?? '-'}
        </div>
        <div style="font-size:12px;margin-top:6px;white-space:pre-wrap;">${mission.response ?? ''}</div>
        <div class="mission-row" style="margin-top:8px;">
          <button type="button" onclick="(function(){ const m=PENDING_MISSIONS.get(${id}); if(m) postMissionToBackend(m); })()">임무전송</button>
          <button type="button" onclick="navigator.clipboard?.writeText(JSON.stringify(PENDING_MISSIONS.get(${id})))">JSON복사</button>
        </div>
      `;
      appendBubble(summary, 'bubble-bot');
    }
   
    async function sendMission(zone_id, lat, lon, ph, do_mg_l, bod_mg_l, cod_mg_l, t_n_mg_l, 
          t_p_mg_l, chl_a_mg_m3, cd_mg_l, cl_mg_l, ss_mg_l, toc_mg_l, ec_us_cm, temp_c, curr_wq_state, target_wq_state) {
      if (sending) return;
      sending = true;

      // 임무생성 대화 시작(예시): 운영자 확인용 초기 프롬프트
      // const text = `임무생성을 시작합니다. 타겟 타일: ${zone_id}. 목표(예: 조류 저감/spray, 순찰/patrol, 시료채취/sample)와 지속시간/제한조건을 입력해 주세요.`;
      const idgenerator = new IdGenerator();
      any = typeof center === 'object'
      const params1 = {
        mission_idx: 999, // idgenerator.generateDaily(),
        water_q_idx: 11,
        zone_id: zone_id,
        lat: lat,
        lon: lon,
        curr_wq_state: curr_wq_state,
        target_wq_state: target_wq_state,
        w_data: {
            temp_c: temp_c,
            ph: ph,
            ec_us_cm: ec_us_cm,
            do_mg_l: do_mg_l,
            toc_mg_l: toc_mg_l,
            cod_mg_l: cod_mg_l,
            t_n_mg_l: t_n_mg_l,
            t_p_mg_l: t_p_mg_l,
            ss_mg_l: ss_mg_l,
            cl_mg_l: cl_mg_l,
            chl_a_mg_m3: chl_a_mg_m3,
            cd_mg_l: cd_mg_l,
            bod_mg_l: bod_mg_l,
        },
        curr_windspeed: 2.2,
        fc_windspeed: 1.9,
        curr_fall: 0,
        fc_fall: 1.2,
        curr_datetime: "20250830T154039"
      };
      const text = createWaterQualityJSON(params1);
      // console.log("방법 1 결과:", JSON.stringify(text, null, 2));
      // mission_idx: int
      // water_q_idx: int
      // zone_id: str
      // lat: str
      // lon: str
      // curr_wq_state: str
      // target_wq_state: str
      // w_data: WaterData
      // curr_windspeed: float
      // fc_windspeed: float
      // curr_fall: float
      // fc_fall: float
      // curr_datetime: str
      // feedback: Optional[str] = None
      const mission_req_msg = "임무생성요청\n구역:"+zone_id+" 목표상태:"+target_wq_state;
      appendBubble(mission_req_msg, 'bubble-user');
      
      // 타이핑 표시 ON
      showTyping();

      try {
        // /llm/api/water-quality/analyze     /api/missions/chat
        const res = await fetch('/llm/api/mission/create', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(text)
        });
        const js = await res.json();
        // console.log(JSON.stringify(js));
        // 1) 기본 응답 표시
        // mission_idx: int
        // link_mission_idx: int
        // zone_id: str
        // lat: str
        // lon: str
        // curr_wq_state: str
        // target_wq_state: str
        // response: str
        // appendBubble((js ?? '응답 수신'), 'bubble-bot');
    
        // 2) 응답 내부에서 임무 JSON 추출 시도 (js.mission / js.data / js.payload / echo 문자열 내 JSON 등)
        const mission =
          tryExtractMission(js.mission) ??
          tryExtractMission(js.data) ??
          tryExtractMission(js.payload) ??
          tryExtractMission(js.result) ??
          tryExtractMission(js.echo) ??
          tryExtractMission(js);
    
        // 타이핑 표시 OFF 후 답변 렌더
        hideTyping();

        if(mission){
          // 3) 액션 버블(임무전송 버튼 포함) 렌더
          await renderMissionActionBubble(mission);
        }else{
          // 임무 JSON이 없는 응답이면 안내만
          // appendBubble('임무 데이터 없음', 'bubble-bot');
        }
      } catch (e) {
        appendBubble("전송 오류가 발생했습니다.", 'bubble-bot');
        console.error(e);
      } finally {
        sending = false;
      }
    }
    
    async function sendChat(){
      if (sending) return;
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
    
      sending = true;
      appendBubble(text, 'bubble-user');
      input.value = '';
    
      try {
        const res = await fetch('/api/missions/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({text})
        });
        const js = await res.json();
    
        // 1) 기본 응답 표시
        appendBubble((js.zone_id ?? '응답 수신'), 'bubble-bot');
    
        // 2) 응답 내부에서 임무 JSON 추출 시도 (js.mission / js.data / js.payload / echo 문자열 내 JSON 등)
        const mission =
          tryExtractMission(js.mission) ??
          tryExtractMission(js.data) ??
          tryExtractMission(js.payload) ??
          tryExtractMission(js.result) ??
          tryExtractMission(js.echo) ??
          tryExtractMission(js);
    
        if(mission){
          // 3) 액션 버블(임무전송 버튼 포함) 렌더
          await renderMissionActionBubble(mission);
        }else{
          // 임무 JSON이 없는 응답이면 안내만
          // appendBubble('임무 데이터 없음', 'bubble-bot');
        }
      } catch (e) {
        appendBubble("전송 오류가 발생했습니다.", 'bubble-bot');
        console.error(e);
      } finally {
        sending = false;
      }
    }

    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) {
        e.preventDefault();
        sendChat();
      }
    });
    document.getElementById('send-btn').addEventListener('click', sendChat);

    // ---------- 비디오 ----------
    function openVideo(droneId, url){
      if(!url){ alert('영상 URL이 없습니다.'); return; }
      document.getElementById('videoTitle').innerText = `드론 영상 — ${droneId}`;
      document.getElementById('videoStream').src = url;
      document.getElementById('videoModal').style.display = 'block';
    }
    function hideVideo(){
      document.getElementById('videoStream').src = '';
      document.getElementById('videoModal').style.display = 'none';
    }
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMWbW9XsmST7vLjFZcGo6jp2rMR_VwvzE&callback=initMap"></script>
  <script type="text/javascript" src="dashboard.js"></script>
</body>
</html>
