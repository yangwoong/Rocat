
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dashboard (50m Grid)</title>
  <style>
    html, body { margin:0; height:100%; }
    body { display:flex; font-family: system-ui, Arial, sans-serif; }
    #map { flex:2; }
    #side { flex:1; display:flex; flex-direction:column; border-left:1px solid #ddd; }
    #drone { flex:1; padding:12px; overflow:auto; }
    #chat { flex:1; display:flex; flex-direction:column; border-top:1px solid #eee; padding:12px; }
    #chat-log { flex:1; overflow:auto; border:1px solid #eee; padding:8px; }
    #chat-box { display:flex; gap:8px; margin-top:8px; }
    input[type=text] { flex:1; padding:8px; }
    button { padding:8px 12px; }
    .card { border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:8px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eee; margin-right:6px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="side">
    <div id="drone">
      <h2>드론 상태</h2>
      <div id="drone-list"></div>
      <button onclick="mockDrone()">드론상태 샘플 등록</button>
      <h3>최근 수질</h3>
      <div id="wq"></div>
    </div>
    <div id="chat">
      <h2>임무 채팅</h2>
      <div id="chat-log"></div>
      <div id="chat-box">
        <input id="chat-input" type="text" placeholder="예) C7 타일 3분간 spray"/>
        <button onclick="sendChat()">전송</button>
      </div>
    </div>
  </div>

  <script>
    let map, recs = [];

    async function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.3804191, lng: 127.0028335}, zoom: 17
      });
      await drawGrid();  // DB의 50m 격자 표시
      refreshWQ(); setInterval(refreshWQ, 3000);
      refreshDrones(); setInterval(refreshDrones, 3000);
    }

    function clearGrid(){
      recs.forEach(r => r.poly.setMap(null));
      recs = [];
    }

    function ragColor(chla){
      if(chla < 10) return '#64B5F6';     // BLUE
      if(chla < 20) return '#FFF176';     // YELLOW
      if(chla < 30) return '#FFB74D';     // ORANGE
      return '#E57373';                   // RED
    }

    async function drawGrid(){
      clearGrid();
      const res = await fetch('http://211.43.213.175:8580/api/tiles' );
      const js = await res.json();
      if(!js.ok){ alert('타일 조회 에러'); return; }

      for(const f of js.features){
        const path = f.geometry.coordinates[0].map(([lng,lat])=>({lat, lng}));
        const poly = new google.maps.Polygon({
          paths: [path],
          strokeColor: '#546E7A', strokeOpacity: 0.8, strokeWeight: 1,
          fillColor: '#ECEFF1', fillOpacity: 0.15
        });
        poly.setMap(map);

        // -------- 타일명 표시 (좌상단 모서리) --------
        let  corner = path[0]; // 좌상단 모서리 좌표
        // 좌표들 중 위도(lat)가 가장 크고, 경도(lng)가 가장 작은 점 찾기
        corner = path.reduce((best, p) => {
          if (!best) return p;
          if (p.lat > best.lat || (p.lat === best.lat && p.lng < best.lng)) {
            return p;
          }
          return best;
        }, null);

        const labelDiv = document.createElement("div");
        labelDiv.style.position = "absolute";
        labelDiv.style.color = "black";
        labelDiv.style.fontSize = "10px";
        labelDiv.innerText = f.properties.zone_id;

        const overlay = new google.maps.OverlayView();
        overlay.onAdd = function(){
          const layer = this.getPanes().overlayLayer;
          layer.appendChild(labelDiv);
        };
        overlay.draw = function(){
          const proj = this.getProjection();
          const pos = proj.fromLatLngToDivPixel(new google.maps.LatLng(corner.lat, corner.lng));
          labelDiv.style.left = pos.x + "px";
          labelDiv.style.top = pos.y + "px";
        };
        overlay.onRemove = function(){ labelDiv.parentNode.removeChild(labelDiv); };
        overlay.setMap(map);

        recs.push({zone_id: f.properties.zone_id, poly, overlay, chl_a_mg_m3: null});
      }
    }

    async function refreshWQ(){
      const res = await fetch('http://211.43.213.175:8580/api/samples/latest'); 
      const js = await res.json();
      const list = document.getElementById('wq');
      list.innerHTML = '';
      const latestMap = new Map();
      for(const s of js.items){
        latestMap.set(s.zone_id, s);
      }
      for(const r of recs){
        const s = latestMap.get(r.zone_id);
        if(s){
          r.chl_a_mg_m3 = s.chl_a_mg_m3;
          r.poly.setOptions({fillColor: ragColor(s.chl_a_mg_m3), fillOpacity: 0.5});
          let badge = "BLUE";
          if(s.chl_a_mg_m3 < 10) badge = "BLUE";
          else if(s.chl_a_mg_m3 < 20) badge = "YELLOW";
          else if(s.chl_a_mg_m3 < 30) badge = "ORANGE";
          else badge = "RED";
          const row = document.createElement('div');
          row.className='card';
          row.innerHTML = `<div><span class="badge">${badge}</span> <b>${r.zone_id}</b> — Chl-a ${s.chl_a_mg_m3.toFixed(1)}, DO ${s.do_mg_l.toFixed(1)}</div>`;
          list.appendChild(row);
        }
      }
    }

    async function refreshDrones(){
      const res = await fetch('http://211.43.213.175:8580/api/drones'); 
      const js = await res.json();
      const cont = document.getElementById('drone-list');
      cont.innerHTML = '';
      for(const [id, d] of Object.entries(js.drones)){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<b>${id}</b><br/>status: ${d.status || 'IDLE'} / battery: ${d.battery || 100}% / tile: ${d.zone_id || '-'}`;
        cont.appendChild(div);
      }
    }

    async function mockDrone(){
      await fetch('http://211.43.213.175:8580/api/drones', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id:'drone1', status:'ACTIVE', battery:94, zone_id:'C7'})
      });
      await refreshDrones();
    }

    async function sendChat(){
      const text = document.getElementById('chat-input').value;
      if(!text) return;
      const log = document.getElementById('chat-log');
      log.innerHTML += `<div>👤 ${text}</div>`;
      document.getElementById('chat-input').value='';
      const res = await fetch('http://211.43.213.175:8580/api/missions/chat', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})
      });
      const js = await res.json();
      log.innerHTML += `<div>🤖 수신됨: ${js.echo}</div>`;
      log.scrollTop = log.scrollHeight;
    }
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMWbW9XsmST7vLjFZcGo6jp2rMR_VwvzE&callback=initMap"></script>
</body>
</html>
